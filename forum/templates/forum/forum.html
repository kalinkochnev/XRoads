{% extends 'layout.html' %}
{% load static %}

{% block content %}

    <style>
        .selected {
            background-color: aqua;
        }
    </style>

    <div class="container">
        <center><h1>{{ subforum.name }}</h1></center>
        <div class="container">
            <div class="row justify-content-between">
                <div class="col">
                    <!--TODO fix back button -->
                    <button type="button" class="btn btn-primary float-left">Back</button>
                    <button type="button" class="btn btn-secondary float-left" onClick="window.location.reload();">
                        Refresh Posts
                    </button>
                </div>
                <div class="col align-right">
                    {% if request.user.is_authenticated %}
                        <a href="{% url 'forumsapp:create_post' %}">
                            <button type="button" class="btn btn-success float-right">Create Post</button>
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        <br>

        {% for post in post_list %}
            <div class="card">
                <div class="card-body">
                    <div class="float-left w-80">
                        <h5 class="card-title" id="post-title">
                            <a href="{% url 'forumsapp:forum_post' post_id=post.id forum_name=subforum.url_name %}">{{ post.title }}</a>
                        </h5>
                        <h6 class="card-subtitle mb-2 text-muted"
                            id="post-user">{{ post.user.alias }}#{{ post.user.user_tag }}</h6>
                    </div>
                    <div class="float-right align-middle">
                        <button class="upvote_button" data-postid="{{ post.id }}">
                            <label class="mb-0">{{ post.upvote_count }}</label>
                            Upvote
                        </button>
                        <button class="downvote_button" data-postid="{{ post.id }}">
                            <label class="mb-0">{{ post.downvote_count }}</label>
                            Downvote
                        </button>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>



    <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
    <script>
        $(document).ready(function () {

            function getCookie(name) {
                var cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    var cookies = document.cookie.split(';');
                    for (var i = 0; i < cookies.length; i++) {
                        var cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            function csrfSafeMethod(method) {
                // these HTTP methods do not require CSRF protection
                return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
            }

            $.ajaxSetup({
                beforeSend: function (xhr, settings) {
                    if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
                        xhr.setRequestHeader("X-CSRFToken", getCookie('csrftoken'));
                    }
                }
            });

            // actions for clicking the upvote button
            $('.upvote_button').click(function (event) {
                is_button_selected(this, upvote, "upvote")
            });

            // Actions for clicking the downvote button
            $('.downvote_button').click(function (event) {
                is_button_selected(this, downvote, "downvote")
            });

            function clearvote(obj) {
                $(obj).prev().removeClass('selected');
                $(obj).removeClass('selected');

                var this_votecount = parseInt($(obj, "label").text()) - 1;
                $("label", obj).text(this_votecount)
            }

            function upvote(obj) {
                var sibling = $(obj).next();

                $(obj).addClass('selected');

                var votecount = parseInt($("label", obj).text());
                $("label", obj).text(votecount + 1)
            }

            function downvote(obj) {
                var sibling = $(obj).prev();
                $(obj).addClass('selected');

                var vote_count = parseInt($("label", obj).text());
                $("label", obj).text(vote_count + 1)
            }

            function send_vote(action_str, postid, success_func = '', error_func = '') {
                var $url = window.location.href;
                var post_data = {
                    action: action_str,
                    post_id: postid,
                };
                console.log($url);
                $.ajax({
                    url: $url,
                    type: "POST",
                    data: post_data,
                    success: success_func,
                    error: error_func,
                });
            }

            function FormSuccess(data, textStatus, jqXHR) {
                console.log(data);
                console.log(textStatus);
                console.log(jqXHR)
            }

            function FormError(jqXHR, textStatus, errorThrown) {
                console.log(jqXHR);
                console.log(textStatus);
                console.log(errorThrown)
            }

            function is_button_selected(obj, vote_type, vote_str) {
                var id = $(obj).attr('data-postid');
                var parentDiv = $(obj).parent();
                var sibling = $(obj).siblings()[0];

                if ($(obj).hasClass('selected') === false) {
                    // If the other button was selected deselect and decrease vote
                    if ($(sibling).hasClass('selected')) {
                        var vote_count = parseInt($("label", sibling).text());
                        $("label", sibling).text(vote_count - 1);

                        $(sibling).removeClass('selected')
                    }

                    send_vote(vote_str, id);
                    vote_type(obj)
                } else if ($(obj).hasClass('selected')) {
                    send_vote('clearvote', id);
                    clearvote(obj)
                }
            }

        })

        // If the button is not selected
        // if the sibling was selected
        // decrease the sibling votecount by 1
        // deselect the sibling
        // add selected class
        // increase the vote count by 1
        // If the button was selected
        // decrease vote count by 1
        // remove selection from both buttons

    </script>

{% endblock %}

